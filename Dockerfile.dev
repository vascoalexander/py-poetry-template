# Dockerfile.dev

ARG PYTHON_VERSION=3.12
FROM python:${PYTHON_VERSION}-slim-bookworm

# Build-Args für User-Mapping
ARG USERNAME=appuser
ARG USER_UID=1000
ARG USER_GID=1000

# System-Tools
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        git curl \
    && rm -rf /var/lib/apt/lists/*

# Git: /app als sicher markieren
RUN git config --global --add safe.directory /app

# User anlegen
RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME}

# Poetry
ENV POETRY_HOME="/opt/poetry"
ENV PATH="${POETRY_HOME}/bin:${PATH}"
ENV POETRY_VIRTUALENVS_IN_PROJECT=false
ENV POETRY_NO_INTERACTION=1

RUN curl -sSL https://install.python-poetry.org | python3 - --version 1.8.3 \
    && chown -R ${USERNAME}:${USERNAME} ${POETRY_HOME}

WORKDIR /app

# Set ownership for /app
RUN chown -R ${USERNAME}:${USERNAME} /app

# Wechsel zu App-User
USER ${USERNAME}
ENV HOME="/home/${USERNAME}"

# Vorab nur Poetry-Dateien für besseren Build-Cache
COPY pyproject.toml poetry.lock ./

RUN poetry install --no-root --sync --with dev

CMD ["bash"]
