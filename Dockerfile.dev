# Dockerfile.dev

ARG PYTHON_VERSION=3.12
FROM python:${PYTHON_VERSION}-slim-bookworm

# Build-Args f端r User-Mapping
ARG USERNAME=appuser
ARG USER_UID=1000
ARG USER_GID=1000

# System-Tools
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        git curl \
    && rm -rf /var/lib/apt/lists/*

# Git: /app als sicher markieren
RUN git config --global --add safe.directory /app

# User anlegen mit Host-UID/GID
RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} \
    && usermod -aG sudo ${USERNAME}  # Optional, falls sudo gebraucht wird

# Poetry
ENV POETRY_HOME="/opt/poetry"
ENV PATH="${POETRY_HOME}/bin:${PATH}"
ENV POETRY_VIRTUALENVS_IN_PROJECT=false
ENV POETRY_NO_INTERACTION=1

RUN curl -sSL https://install.python-poetry.org | python3 - --version 1.8.3 \
    && chown -R ${USERNAME}:${USERNAME} ${POETRY_HOME}

WORKDIR /app

# Set ownership f端r /app (wichtig f端r gemountete Volumes)
RUN chown -R ${USERNAME}:${USERNAME} /app

# Wechsel zu User mit Host UID/GID
USER ${USERNAME}
ENV HOME="/home/${USERNAME}"

# Kopiere Poetry-Dateien f端r Cache
COPY pyproject.toml poetry.lock ./

RUN poetry install --no-root --sync --with dev

CMD ["bash"]
