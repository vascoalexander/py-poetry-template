FROM python:3.12-slim

ENV USERNAME=appuser \
    UID=1000 \
    GID=1000 \
    MISE_HOME=/home/appuser/.local/share/mise

# System-Abhängigkeiten
RUN apt-get update && apt-get install -y \
    curl build-essential git sudo \
    && rm -rf /var/lib/apt/lists/*

# User erstellen
RUN groupadd --gid ${GID} ${USERNAME} \
    && useradd --uid ${UID} --gid ${GID} -m ${USERNAME} \
    && usermod -aG sudo ${USERNAME}

USER ${USERNAME}
WORKDIR /app
ENV HOME=/home/${USERNAME}
ENV PATH="${MISE_HOME}/shims:${MISE_HOME}/bin:$PATH"

# mise installieren
RUN curl -sSf https://mise.run | sh

# Python, poetry & Tools via mise installieren
COPY --chown=appuser:appuser mise.toml .
RUN mise install

# Globale Konfiguration: kein in-project venv
RUN mise exec -- poetry config virtualenvs.in-project false

# Abhängigkeiten installieren
COPY --chown=appuser:appuser pyproject.toml poetry.lock ./
RUN mise exec -- poetry install --no-root --sync --with dev