# Dockerfile.dev

ARG PYTHON_VERSION=3.12

FROM python:${PYTHON_VERSION}-slim-bookworm

# Systemaktualisierung und Git-Installation
RUN apt-get update \
    && apt-get install -y --no-install-recommends git curl \
    && rm -rf /var/lib/apt/lists/*

# Git-Konfiguration für /app
RUN git config --global --add safe.directory /app

# Erstelle den Nicht-Root-Benutzer 'appuser'
RUN adduser --system --group --uid 1000 --shell /bin/bash appuser

# Setze Umgebungsvariablen für Poetry. POETRY_HOME wird hier verwendet,
# um den Installationspfad festzulegen.
ENV POETRY_HOME="/opt/poetry" \
    POETRY_VIRTUALENVS_IN_PROJECT=false \
    POETRY_NO_INTERACTION=1

# Installiere Poetry als root in das definierte POETRY_HOME
# Curl benötigt Schreibrechte für den Download, Python für die Installation.
# Dieses Skript sollte den Ordner /opt/poetry selbst erstellen, wenn es nicht existiert.
RUN curl -sSL https://install.python-poetry.org | python3 - --version 1.8.3

# NEU: Überprüfe, ob /opt/poetry tatsächlich existiert nach der Installation (Debug-Schritt)
# Wenn dieser Befehl fehlschlägt, dann hat Poetry nicht dorthin installiert.
RUN test -d "${POETRY_HOME}" || (echo "ERROR: ${POETRY_HOME} was not created by Poetry installation!" && exit 1)

# Ändere den Besitzer des Poetry-Installationsverzeichnisses zu appuser.
# Dies ist entscheidend, damit der appuser später Poetry nutzen kann.
# Hier muss /opt/poetry definitiv existieren.
RUN chown -R appuser:appuser "${POETRY_HOME}"

# Definiere den PATH für den Container, um die Poetry-Binaries zu finden
ENV PATH="${POETRY_HOME}/bin:${PATH}"

# Setze das Arbeitsverzeichnis für das Projekt
WORKDIR /app

# Stelle sicher, dass der appuser Schreibrechte im Arbeitsverzeichnis hat.
# Wichtig, falls /app nicht gemountet wird oder für Caches innerhalb des Containers.
RUN chown -R appuser:appuser /app

# Wechsle zum Nicht-Root-Benutzer für nachfolgende Befehle und zur Laufzeit
USER appuser

# Kopiere die Poetry-Konfigurationsdateien, um den Docker-Layer-Cache zu optimieren
COPY pyproject.toml poetry.lock ./

# Installiere die Projekt-Abhängigkeiten (Produktion und Entwicklung)
RUN poetry install --no-root --sync --with dev

# Standardbefehl beim Starten des Containers
CMD ["bash"]